<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการโค้ด</title>
    <!-- Bootstrap & Font Awesome -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- START: Add Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css">
    <!-- END: Add Select2 CSS -->

    <style>
      :root {
        --theme-pink: #F8C8DC; --theme-pink-hover: #f7b4d1; --theme-pink-light: #FFF0F5;
        --theme-dark-text: #4A4A4A; --theme-border: #E0E0E0; --theme-success: #28a745; --theme-warning: #ffc107; --theme-info: #17a2b8; --theme-danger: #dc3545;
      }
      body { background-color: var(--theme-pink-light); color: var(--theme-dark-text); font-family: 'Kanit', sans-serif; }
      .container { max-width: 1000px; background-color: #ffffff; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 0; margin: 2rem auto; overflow: hidden; }
      .main-header { background-color: var(--theme-pink); color: white; padding: 1.5rem; text-align: center; display: flex; justify-content: space-between; align-items: center; }
      .nav-tabs { border-bottom: none; background-color: var(--theme-pink-light); padding: 8px; border-radius: 10px; margin: 1.5rem 1.5rem 0 1.5rem; }
      .nav-tabs .nav-item { flex: 1; text-align: center; }
      .nav-tabs .nav-link { border: none; border-radius: 8px; color: var(--theme-dark-text); padding: 0.75rem; font-weight: 500; transition: all 0.3s ease; margin: 0 4px; }
      .nav-tabs .nav-link:not(.active):hover { background-color: #ffffff; color: var(--theme-pink); }
      .nav-tabs .nav-link.active { background-color: var(--theme-pink); color: white; box-shadow: 0 4px 8px rgba(248, 200, 220, 0.6); }
      .tab-content, #auth-container .card-body { padding: 1.5rem; }
      .form-group label { font-weight: 500; margin-bottom: 0.5rem; display: block; }
      .form-control, .custom-select { border-radius: 8px; border: 1px solid var(--theme-border); padding: 0.75rem 1rem; height: auto; }
      .form-control:focus { border-color: var(--theme-pink); box-shadow: 0 0 0 0.2rem rgba(248, 200, 220, 0.5); }
      .btn-custom { background-color: var(--theme-pink); border-color: var(--theme-pink); color: white; font-weight: 500; padding: 0.75rem; border-radius: 8px; width: 100%; transition: background-color 0.2s; }
      .btn-custom:hover { background-color: var(--theme-pink-hover); border-color: var(--theme-pink-hover); color: white; }
      #logoutBtn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
      #loadingModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 1050; align-items: center; justify-content: center; }
      .spinner-border { color: var(--theme-pink); }
      
      /* Table & Sticky Header */
      .table-responsive { max-height: 500px; overflow-y: auto; border: 1px solid #eee; }
      thead th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 1; box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); }

      /* --- Dashboard Cards (Adjusted Height) --- */
      .dashboard-group h5 { font-weight: bold; color: var(--theme-dark-text); border-bottom: 2px solid var(--theme-pink-light); padding-bottom: 0.5rem; }
      .dashboard-card-small { 
          padding: 0.75rem 0.5rem; margin-bottom: 0.75rem; border-radius: 8px; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.04); border: 1px solid #eee; 
      }
      .dashboard-card-small .icon { font-size: 1.4rem; margin-bottom: 0.1rem; }
      .dashboard-card-small h4 { font-size: 1.4rem; font-weight: bold; margin-bottom: 0; }
      .dashboard-card-small p { margin: 0; font-size: 0.75rem; color: #6c757d; }
      .card-total { background-color: var(--theme-pink-light); } .card-total .icon { color: var(--theme-pink); }
      .card-used { background-color: #e9f5ea; } .card-used .icon { color: var(--theme-success); }
      .card-expired { background-color: #fff8e1; } .card-expired .icon { color: var(--theme-warning); }
      .card-remaining { background-color: #e3f2fd; } .card-remaining .icon { color: var(--theme-info); }
      
      /* --- Report Table Styles --- */
      .table-report-monthly th, .table-report-monthly td { text-align: center; vertical-align: middle; }
      .table-report-monthly th:first-child, .table-report-monthly td:first-child { text-align: left; }
      
      /* Styles สำหรับแถวที่คลิกได้และการขยาย */
      .clickable-row { cursor: pointer; background-color: #fff; transition: background-color 0.2s; }
      .clickable-row:hover { background-color: #f8f9fa; }
      .clickable-row i.fa-chevron-down { transition: transform 0.3s; }
      .clickable-row[aria-expanded="true"] i.fa-chevron-down { transform: rotate(180deg); }
      .detail-row { background-color: #fcfcfc; font-size: 0.9rem; color: #555; }
      .detail-row td { border-top: none; }
      .branch-name { padding-left: 20px; font-style: italic; }

      /* START: CSS Fix for Select2 with Input Group */
      .input-group .select2-container--bootstrap4 {
        flex: 1 1 auto;
      }
      .select2-container--bootstrap4 .select2-selection--single {
          height: calc(1.5em + .75rem + 2px) !important;
      }
      .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered {
          line-height: calc(1.5em + .75rem) !important;
      }
      /* END: CSS Fix for Select2 */

      @media (max-width: 576px) {
        .nav-tabs .nav-link { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.8rem; padding: 0.5rem 0.25rem; height: 60px; }
        .nav-tabs .nav-link i.fas { margin-bottom: 4px; font-size: 1.1rem; }
      }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    
    <div class="container" id="auth-container" style="display: none;">
        <div class="main-header"><h2><i class="fas fa-lock"></i> ระบบจัดการโค้ด</h2></div>
        <div class="card-body">
            <form id="login-form">
                <h5 class="mb-4 text-center text-secondary">กรุณาเข้าสู่ระบบเพื่อใช้งาน</h5>
                <div class="form-group"><label for="email">อีเมล</label><input type="email" id="email" class="form-control" required placeholder="example@email.com"></div>
                <div class="form-group"><label for="password">รหัสผ่าน</label><input type="password" id="password" class="form-control" required placeholder="••••••••"></div>
                <button type="submit" class="btn btn-custom mt-3"><i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบ</button>
            </form>
        </div>
    </div>

    <div class="container" id="app-container" style="display: none;">
      <div class="main-header">
        <h2><i class="fas fa-ticket-alt"></i> ระบบจัดการโค้ด</h2>
        <button id="logoutBtn" title="ออกจากระบบ"><i class="fas fa-sign-out-alt"></i></button>
      </div>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#use-code"><i class="fas fa-hand-pointer"></i> ใช้โค้ด</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#import"><i class="fas fa-file-upload"></i> นำเข้าโค้ด</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#manage"><i class="fas fa-tasks"></i> จัดการโค้ด</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#report"><i class="fas fa-chart-pie"></i> รายงาน</a></li>
      </ul>

      <div class="tab-content">
        <!-- Tab: ใช้โค้ด -->
        <div class="tab-pane fade show active" id="use-code">
            <h5 class="mb-3">เลือกและบันทึกการใช้งาน</h5>
            <div class="form-group"><label for="filterCodeType">ประเภทโค้ด</label><select class="custom-select" id="filterCodeType" onchange="loadAvailableCodes()"><option value="">-- กรุณาเลือก --</option></select></div>
            <div class="form-group"><label for="availableCodes">โค้ดที่ใช้งานได้</label><div class="input-group"><select class="custom-select" id="availableCodes"></select><div class="input-group-append"><button class="btn btn-outline-secondary" id="copyCodeBtn" onclick="copySelectedCode()" disabled><i class="far fa-copy"></i></button></div></div></div>
            <hr class="my-4">
            <div class="form-group"><label for="branch">เลขสาขา</label><div class="input-group"><select class="custom-select" id="branch"></select><div class="input-group-append"><button class="btn btn-outline-secondary" onclick="addNewOption('branch', 'เลขสาขาใหม่')">+</button></div></div></div>
            <div class="form-group"><label for="useDate">วันที่ใช้งาน</label><input type="date" class="form-control" id="useDate"></div>
            <div class="form-group"><label for="notes">หมายเหตุ (ถ้ามี)</label><textarea class="form-control" id="notes" rows="2"></textarea></div>
            <button class="btn btn-custom mt-3" onclick="handleUseCode()"><i class="fas fa-check-circle"></i> บันทึกการใช้งาน</button>
        </div>
        <!-- Tab: นำเข้า -->
        <div class="tab-pane fade" id="import">
            <h5 class="mb-3">นำเข้าโค้ดจากไฟล์ Excel</h5>
            <div class="alert alert-info py-2" style="font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> รูปแบบไฟล์: คอลัมน์ A = รหัสโค้ด, คอลัมน์ B = สถานะ (ใส่ 'ถูกใช้แล้ว' หรือ 'used' หากใช้แล้ว)
            </div>
            <div class="form-group"><label for="xlsFile">เลือกไฟล์ (.xls, .xlsx)</label><input type="file" class="form-control-file" id="xlsFile" accept=".xls, .xlsx"></div>
            <div class="form-group"><label for="importCodeType">ประเภทโค้ดสำหรับไฟล์นี้</label><div class="input-group"><select class="custom-select" id="importCodeType"></select><div class="input-group-append"><button class="btn btn-outline-secondary" onclick="addNewOption('importCodeType', 'ประเภทโค้ดใหม่')">+</button></div></div></div>
            <div class="form-group"><label for="expiryDate">วันหมดอายุสำหรับไฟล์นี้</label><input type="date" class="form-control" id="expiryDate"></div>
            <button class="btn btn-custom mt-3" onclick="handleImport()"><i class="fas fa-file-import"></i> นำเข้าข้อมูล</button>
        </div>
        
        <!-- Tab: จัดการโค้ด -->
        <div class="tab-pane fade" id="manage">
            <h5 class="mb-3">จัดการสถานะโค้ด</h5>
            <div class="row">
                <div class="col-md-3 form-group"><label>วันที่สร้าง</label><select id="manageFilterDate" class="custom-select" onchange="loadCodesForManagement()"></select></div>
                <div class="col-md-3 form-group"><label>สถานะ</label><select id="manageFilterStatus" class="custom-select" onchange="loadCodesForManagement()"><option value="">ทุกสถานะ</option><option value="ยังไม่ใช้">ยังไม่ใช้</option><option value="ใช้แล้ว">ใช้แล้ว</option><option value="หมดอายุ">หมดอายุ</option><option value="ยกเลิก">ยกเลิก</option></select></div>
                <div class="col-md-4 form-group"><label>ค้นหาโค้ด</label><input type="text" id="manageFilterSearch" class="form-control" placeholder="กรอกโค้ดบางส่วน..."></div>
                <div class="col-md-2 form-group d-flex align-items-end"><button class="btn btn-info w-100" onclick="loadCodesForManagement()"><i class="fas fa-filter"></i> กรอง</button></div>
            </div>
            <hr>
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 40px;"><input type="checkbox" id="selectAllCheckbox" onclick="toggleAllCheckboxes(this.checked)"></th>
                            <th scope="col">โค้ด</th>
                            <th scope="col">ประเภท</th>
                            <th scope="col">สถานะ</th>
                            <th scope="col">สาขาที่ใช้</th>
                            <th scope="col">วันที่ใช้</th>
                            <th scope="col">วันที่สร้าง</th>
                            <th scope="col">วันหมดอายุ</th>
                            <th scope="col">แก้ไข</th>
                        </tr>
                    </thead>
                    <tbody id="manageCodesTableBody"></tbody>
                </table>
            </div>
            <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-danger" onclick="handleCancelCodes()"><i class="fas fa-times-circle"></i> ยกเลิกโค้ดที่เลือก</button>
                <button id="exportBtn" class="btn btn-success" onclick="handleSmartExport()"><i class="fas fa-download"></i> Export ข้อมูลทั้งหมด</button>
            </div>
        </div>

        <!-- Tab: รายงาน -->
        <div class="tab-pane fade" id="report">
            <div class="d-flex justify-content-between align-items-center"><h5 class="mb-3">Dashboard สรุปภาพรวม</h5><button class="btn btn-success mb-3" onclick="handleExport('dashboard')"><i class="fas fa-download"></i> Export ข้อมูล Dashboard</button></div>
            <div id="dashboard-container"></div>
            <hr>
            <h5 class="mb-3">ตารางสรุปการใช้งาน (รายปี)</h5>
            <div class="alert alert-light" role="alert"><i class="fas fa-info-circle"></i> คลิกที่ชื่อประเภทโค้ดเพื่อดูรายละเอียดสาขา</div>
            <div class="form-group row">
                <label for="reportYear" class="col-sm-3 col-form-label">เลือกปีที่ต้องการดู:</label>
                <div class="col-sm-9"><select class="custom-select" id="reportYear" onchange="loadUsageReport()"></select></div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-report-monthly">
                    <thead class="thead-light">
                        <tr>
                            <th style="width: 20%;">ประเภทโค้ด / สาขา</th>
                            <th>ม.ค.</th><th>ก.พ.</th><th>มี.ค.</th><th>เม.ย.</th>
                            <th>พ.ค.</th><th>มิ.ย.</th><th>ก.ค.</th><th>ส.ค.</th>
                            <th>ก.ย.</th><th>ต.ค.</th><th>พ.ย.</th><th>ธ.ค.</th>
                            <th style="width: 8%;">รวม</th>
                        </tr>
                    </thead>
                    <tbody id="usageReportTableBody"></tbody>
                </table>
            </div>
            <button class="btn btn-success mt-3" onclick="handleExport('usage_report')"><i class="fas fa-download"></i> Export ตารางการใช้งาน (พร้อมรายละเอียดสาขา)</button>
        </div>
      </div>
    </div>

    <div id="loadingModal"><div class="spinner-border" role="status"></div></div>

    <div class="modal fade" id="editCodeModal" tabindex="-1" aria-labelledby="editCodeModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editCodeModalLabel">แก้ไขข้อมูลโค้ด</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <form id="edit-code-form">
              <input type="hidden" id="edit-code-id">
              <div class="form-group"><label>โค้ด</label><input type="text" id="edit-code-value" class="form-control" readonly></div>
              <div class="form-group"><label for="edit-code-type">ประเภทโค้ด</label><input type="text" id="edit-code-type" class="form-control" required></div>
              <div class="form-group"><label for="edit-expiry-date">วันหมดอายุ</label><input type="date" id="edit-expiry-date" class="form-control" required></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">ปิด</button>
            <button type="button" class="btn btn-primary" onclick="handleUpdateCode()">บันทึกการเปลี่ยนแปลง</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- START: Add Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- END: Add Select2 JS -->


    <script>
      const SUPABASE_URL = 'https://hndcotcxrylyamfjgjwx.supabase.co'; 
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuZGNvdGN4cnlseWFtZmpnand4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzI1MjUsImV4cCI6MjA4MDQwODUyNX0.RsdmQr3xf3R3Jb6pJU7oYVnh12CEzmjxFPytNTsWrgM';

      const { createClient } = supabase;
      const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      const authContainer = document.getElementById('auth-container');
      const appContainer = document.getElementById('app-container');
      const loginForm = document.getElementById('login-form');
      const logoutBtn = document.getElementById('logoutBtn');
      
      let currentUser = null;
      let dashboardSummaryData = {}; 
      let detailedUsageReportData = {}; 
      let currentDisplayedCodes = [];

      _supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
          currentUser = session.user;
          const isServiceUser = currentUser.email === 'toacream1@gmail.com';

          const importTab = document.querySelector('a[href="#import"]').parentElement;
          const manageTab = document.querySelector('a[href="#manage"]').parentElement;

          if (isServiceUser) {
              importTab.style.display = 'none';
              manageTab.style.display = 'none';
              $('#myTab a[href="#use-code"]').tab('show');
          } else {
              importTab.style.display = '';
              manageTab.style.display = '';
          }

          showApp();
          initializeAppData();
        } else {
          currentUser = null;
          showAuth();
        }
      });
      
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading(true);
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        if (error) alert('Login ไม่สำเร็จ: ' + error.message);
        showLoading(false);
      });

      logoutBtn.addEventListener('click', async () => { await _supabase.auth.signOut(); });
      function showApp() { authContainer.style.display = 'none'; appContainer.style.display = 'block'; }
      function showAuth() { appContainer.style.display = 'none'; authContainer.style.display = 'block'; }

      async function callApi(action, payload = {}) {
        showLoading(true);
        try {
            let result;
            switch(action) {
                case 'getDropdownData': {
                    const { data, error } = await _supabase.from('codes').select('code_type, branch_id').neq('status', 'ยกเลิก');
                    if (error) throw error;
                    const codeTypes = [...new Set(data.map(c => c.code_type).filter(Boolean))];
                    const branches = [...new Set(data.map(c => c.branch_id).filter(Boolean))].sort((a, b) => Number(a) - Number(b));
                    result = { codeTypes, branches };
                    break;
                }
                case 'getAvailableCodes': {
                    const { data, error } = await _supabase.from('codes').select('code').eq('code_type', payload.codeType).eq('status', 'ยังไม่ใช้');
                    if (error) throw error;
                    result = data.map(c => String(c.code).replace(/['"‘’“”]/g, '').replace(/&#39;/g, ''));
                    break;
                }
                case 'checkForDuplicates': {
                    const { data, error } = await _supabase.from('codes').select('code').in('code', payload.codes).neq('status', 'ยกเลิก');
                    if (error) throw error;
                    result = data;
                    break;
                }
                case 'importCodes': {
                    const codesToInsert = payload.codes.map(c => ({ 
                        code: c.code, 
                        code_type: payload.codeType, 
                        expiry_date: payload.expiryDate, 
                        status: c.status, 
                        used_at: c.status === 'ใช้แล้ว' ? new Date().toISOString() : null 
                    }));
                    
                    const { error } = await _supabase.from('codes').insert(codesToInsert);
                    if (error) throw error;
                    result = { message: `นำเข้าโค้ด ${payload.codes.length} รายการสำเร็จ!` };
                    break;
                }
                case 'useCode': {
                    const { data: updated, error } = await _supabase.from('codes')
                        .update({ status: 'ใช้แล้ว', branch_id: payload.branch, used_at: new Date().toISOString(), notes: payload.notes, user_id: currentUser.id, admin_name: currentUser.email })
                        .eq('code', payload.code).eq('status', 'ยังไม่ใช้').select();
                    if (error) throw error;
                    if (updated.length === 0) throw new Error(`โค้ด ${payload.code} อาจถูกใช้งานไปแล้ว หรือไม่พบในระบบ`);
                    result = { message: `บันทึกการใช้โค้ด ${payload.code} สำเร็จ!` };
                    break;
                }
                case 'getCodesForManagement': {
                    let query = _supabase.from('codes').select('*').order('created_at', { ascending: false });
                    if (payload.creationDate) {
                        const startDate = payload.creationDate, nextDay = new Date(startDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        const endDate = nextDay.toISOString().slice(0, 10);
                        query = query.gte('created_at', startDate).lt('created_at', endDate);
                    }
                    if (payload.status === 'หมดอายุ') {
                        const today = new Date().toISOString().slice(0, 10);
                        query = query.eq('status', 'ยังไม่ใช้').lt('expiry_date', today);
                    } else if (payload.status) { 
                        query = query.eq('status', payload.status); 
                    }
                    if (payload.searchTerm) { query = query.ilike('code', `%${payload.searchTerm}%`); }
                    const { data, error } = await query;
                    if (error) throw error;
                    result = data;
                    break;
                }
                 case 'cancelCodes': {
                    const { error } = await _supabase.from('codes').update({ status: 'ยกเลิก' }).in('code', payload.codes);
                    if (error) throw error;
                    result = { message: `ยกเลิกโค้ด ${payload.codes.length} รายการสำเร็จ` };
                    break;
                }
                case 'getAllDataForReport': {
                    const { data, error } = await _supabase.from('codes').select('*').neq('status', 'ยกเลิก').order('created_at', { ascending: false });
                    if (error) throw error;
                    result = data;
                    break;
                }
                case 'getUniqueCreationDates': {
                    const { data, error } = await _supabase.from('codes').select('created_at').order('created_at', { ascending: false });
                    if(error) throw error;
                    const uniqueDates = [...new Set(data.map(c => c.created_at.slice(0, 10)))];
                    result = uniqueDates;
                    break;
                }
                case 'updateCodeDetails': {
                    const { error } = await _supabase.from('codes')
                        .update({ code_type: payload.code_type, expiry_date: payload.expiry_date })
                        .eq('id', payload.id);
                    if(error) throw error;
                    result = { message: 'อัปเดตข้อมูลโค้ดสำเร็จ!' };
                    break;
                }
            }
            showLoading(false);
            return result;
        } catch (error) {
            showLoading(false);
            alert('เกิดข้อผิดพลาด: ' + error.message);
            throw error;
        }
      }

      // START: Select2 Helper Function
      function applySearchableDropdown(elementId) {
          const el = $(`#${elementId}`);
          if (el.data('select2')) {
              el.select2('destroy');
          }
          el.select2({ theme: 'bootstrap4' });
      }
      // END: Select2 Helper Function

      document.addEventListener("DOMContentLoaded", () => {
        setTodayDate('useDate');
        $('#availableCodes').on('change', (e) => { // Use jQuery selector for consistency
            document.getElementById('copyCodeBtn').disabled = !e.target.value;
        });
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            const targetTab = $(e.target).attr("href");
            if (targetTab === '#report') { loadDashboardData(); loadUsageReport(); } 
            else if (targetTab === '#manage') { loadCodesForManagement(); }
        });
        // Apply to static dropdowns on page load
        applySearchableDropdown('manageFilterStatus');
      });

      function showLoading(show) { document.getElementById('loadingModal').style.display = show ? 'flex' : 'none'; }
      function setTodayDate(elementId) { document.getElementById(elementId).value = new Date().toISOString().slice(0, 10); }

      function initializeAppData() {
        loadDropdowns();
        populateYearDropdowns();
        if (currentUser && currentUser.email !== 'toacream1@gmail.com') {
            loadUniqueCreationDates();
        }
      }

      async function loadDropdowns() {
        try {
          const data = await callApi('getDropdownData');
          const isServiceUser = currentUser && currentUser.email === 'toacream1@gmail.com';

          if (isServiceUser) {
              const filterSelect = document.getElementById('filterCodeType');
              filterSelect.innerHTML = '<option value="Service" selected>Service</option>';
              // Don't disable the element itself, just the search functionality in select2
              applySearchableDropdown('filterCodeType');
              $('#filterCodeType').prop('disabled', true).trigger('change');

              loadAvailableCodes();
              
              populateSelect('branch', data.branches, '-- เลือกเลขสาขา --');
              applySearchableDropdown('branch');

          } else {
              $('#filterCodeType').prop('disabled', false).trigger('change');
              populateSelect('importCodeType', data.codeTypes, '-- เลือกประเภทโค้ด --');
              applySearchableDropdown('importCodeType');
              populateSelect('filterCodeType', data.codeTypes, '-- กรุณาเลือก --');
              applySearchableDropdown('filterCodeType');
              populateSelect('branch', data.branches, '-- เลือกเลขสาขา --');
              applySearchableDropdown('branch');
          }
        } catch (error) { console.error("โหลด Dropdown ไม่สำเร็จ:", error); }
      }

      function populateSelect(elementId, options, defaultText) {
        const select = document.getElementById(elementId);
        select.innerHTML = `<option value="">${defaultText}</option>`;
        (options || []).forEach(opt => select.add(new Option(opt, opt)));
      }
      
      function populateYearDropdowns() {
          const currentYear = new Date().getFullYear();
          const select = document.getElementById('reportYear');
          select.innerHTML = '';
          for (let i = 0; i < 5; i++) {
              const year = currentYear - i;
              select.add(new Option(year, year));
          }
          applySearchableDropdown('reportYear');
      }

      // START: Modified addNewOption for Select2
      function addNewOption(elementId, promptText) {
        const newValue = prompt(`กรุณาใส่ ${promptText}:`);
        if (newValue && newValue.trim()) {
            const select = $(`#${elementId}`);
            // ตรวจสอบว่ามี option นี้อยู่แล้วหรือไม่
            if (select.find(`option[value='${newValue}']`).length) {
                // ถ้ามีอยู่แล้ว ให้เลือกรายการนั้น
                select.val(newValue).trigger('change');
            } else {
                // ถ้ายังไม่มี ให้สร้าง option ใหม่และเลือก
                const newOption = new Option(newValue, newValue, true, true);
                select.append(newOption).trigger('change');
            }
        }
      }
      // END: Modified addNewOption

      function copySelectedCode() {
        const code = document.getElementById('availableCodes').value;
        if(code) navigator.clipboard.writeText(code).then(() => alert(`คัดลอกโค้ด "${code}" แล้ว`));
      }

      async function handleImport() {
        const file = document.getElementById('xlsFile').files[0];
        const codeType = document.getElementById('importCodeType').value;
        const expiryDate = document.getElementById('expiryDate').value;
        if (!file || !codeType || !expiryDate) return alert('กรุณากรอกข้อมูลนำเข้าให้ครบ');
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const workbook = XLSX.read(e.target.result, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            const importData = json.slice(1).map(row => {
                const rawCode = row[0];
                if (rawCode === null || rawCode === undefined) return null;
                
                let cleanCode = String(rawCode);
                cleanCode = cleanCode.replace(/&#39;/g, '').replace(/&apos;/g, '');
                cleanCode = cleanCode.replace(/['"‘’“”]/g, '').trim();
                if (cleanCode === '') return null;

                let status = 'ยังไม่ใช้';
                if (row[1]) {
                    const statusStr = String(row[1]).trim();
                    if (['used', 'ใช้แล้ว', 'ถูกใช้แล้ว', 'yes'].includes(statusStr.toLowerCase())) {
                        status = 'ใช้แล้ว';
                    }
                }
                
                return { code: cleanCode, status: status };
            }).filter(item => item !== null);

            if (importData.length === 0) return alert("ไม่พบข้อมูลโค้ดในไฟล์ Excel");
            
            try {
                const codesOnly = importData.map(c => c.code);
                const duplicates = await callApi('checkForDuplicates', { codes: codesOnly });
                if (duplicates.length > 0) {
                    alert(`พบโค้ดซ้ำในระบบ (ที่ยังไม่ถูกยกเลิก): ${duplicates.map(d => d.code).join(', ')}\nกรุณาตรวจสอบไฟล์และลองอีกครั้ง`);
                    return;
                }
                const result = await callApi('importCodes', { codes: importData, codeType, expiryDate });
                alert(result.message);
                document.getElementById('xlsFile').value = '';
                initializeAppData();
            } catch (error) { console.error("Import failed:", error); }
        };
        reader.readAsArrayBuffer(file);
      }

      async function loadAvailableCodes() {
        const codeType = document.getElementById('filterCodeType').value;
        const select = document.getElementById('availableCodes');
        document.getElementById('copyCodeBtn').disabled = true;
        select.innerHTML = '<option value="">-- กำลังโหลด... --</option>';
        if (!codeType) { 
            select.innerHTML = '<option value="">-- รอเลือกประเภทโค้ด --</option>'; 
            applySearchableDropdown('availableCodes'); // Apply even if empty
            return; 
        }
        try {
          const codes = await callApi('getAvailableCodes', { codeType });
          populateSelect('availableCodes', codes, codes.length > 0 ? '-- เลือกโค้ด --' : '-- ไม่มีโค้ดที่ใช้งานได้ --');
          applySearchableDropdown('availableCodes');
        } catch (error) { console.error("Load codes failed:", error); }
      }

      async function handleUseCode() {
        const usageData = { code: document.getElementById('availableCodes').value, branch: document.getElementById('branch').value, useDate: document.getElementById('useDate').value, notes: document.getElementById('notes').value };
        if (!usageData.code || !usageData.branch || !usageData.useDate) return alert('กรุณากรอกข้อมูลการใช้งานให้ครบ');
        try {
          const result = await callApi('useCode', usageData);
          alert(result.message);
          document.getElementById('notes').value = '';
          loadAvailableCodes();
          loadDropdowns();
        } catch (error) { console.error("Use code failed:", error); }
      }
      
      async function loadUniqueCreationDates() {
          try {
              const dates = await callApi('getUniqueCreationDates');
              populateSelect('manageFilterDate', dates, 'ทุกวันที่');
              applySearchableDropdown('manageFilterDate');
          } catch(error) { console.error("Failed to load unique creation dates:", error); }
      }

      async function loadCodesForManagement() {
        const filterDate = document.getElementById('manageFilterDate').value;
        const filterStatus = document.getElementById('manageFilterStatus').value;
        const filterSearch = document.getElementById('manageFilterSearch').value;
        const tableBody = document.getElementById('manageCodesTableBody');
        const colspan = 9;
        
        tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">กำลังโหลดข้อมูล...</td></tr>`;
        document.getElementById('exportBtn').disabled = true;

        try {
            const codes = await callApi('getCodesForManagement', { creationDate: filterDate, status: filterStatus, searchTerm: filterSearch });
            
            currentDisplayedCodes = codes;

            if (codes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">ไม่พบข้อมูลตามเงื่อนไขที่เลือก</td></tr>`;
                updateExportButtonState();
                return;
            }
            
            const today = new Date(); today.setHours(0, 0, 0, 0);
            tableBody.innerHTML = '';
            
            codes.forEach(code => {
                let computedStatus = code.status;
                if (code.status === 'ยังไม่ใช้' && new Date(code.expiry_date) < today) {
                    computedStatus = 'หมดอายุ';
                }
                const displayCode = String(code.code).replace(/['"‘’“”]/g, '').replace(/&#39;/g, '');
                
                const branchStr = code.branch_id || '-';
                const usedDateStr = code.used_at ? new Date(code.used_at).toLocaleDateString('th-TH') : '-';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="code-checkbox" data-code="${displayCode}" onchange="updateExportButtonState()"></td>
                    <td>${displayCode}</td>
                    <td>${code.code_type || ''}</td>
                    <td>${computedStatus}</td>
                    <td>${branchStr}</td>
                    <td>${usedDateStr}</td>
                    <td>${new Date(code.created_at).toLocaleDateString('th-TH')}</td>
                    <td>${new Date(code.expiry_date).toLocaleDateString('th-TH')}</td>
                    <td><button class="btn btn-sm btn-warning" onclick='openEditModal(${JSON.stringify(code)})'><i class="fas fa-edit"></i></button></td>
                `;
                tableBody.appendChild(tr);
            });
            updateExportButtonState();

        } catch (error) {
            console.error("Failed to load codes:", error);
            tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
        }
      }

      function toggleAllCheckboxes(checked) { 
          document.querySelectorAll('.code-checkbox').forEach(checkbox => checkbox.checked = checked); 
          updateExportButtonState();
      }

      function updateExportButtonState() {
        const btn = document.getElementById('exportBtn');
        const selectedCount = document.querySelectorAll('.code-checkbox:checked').length;
        
        const filterDate = document.getElementById('manageFilterDate').value;
        const filterStatus = document.getElementById('manageFilterStatus').value;
        const filterSearch = document.getElementById('manageFilterSearch').value;
        const isFiltered = (filterDate !== "" || filterStatus !== "" || filterSearch.trim() !== "");
        const hasData = currentDisplayedCodes.length > 0;

        btn.disabled = !hasData;

        if (selectedCount > 0) {
            btn.innerHTML = `<i class="fas fa-check-square"></i> Export รายการที่เลือก (${selectedCount})`;
            btn.className = "btn btn-primary";
        } else if (isFiltered) {
            btn.innerHTML = `<i class="fas fa-filter"></i> Export ข้อมูลที่กรอง (${currentDisplayedCodes.length})`;
            btn.className = "btn btn-success";
        } else {
            btn.innerHTML = `<i class="fas fa-download"></i> Export ข้อมูลทั้งหมด (${currentDisplayedCodes.length})`;
            btn.className = "btn btn-success";
        }
      }

      async function handleCancelCodes() {
          const selectedCheckboxes = document.querySelectorAll('.code-checkbox:checked');
          if (selectedCheckboxes.length === 0) { return alert('กรุณาเลือกโค้ดที่ต้องการยกเลิก'); }
          if (!confirm(`คุณต้องการยกเลิกโค้ดจำนวน ${selectedCheckboxes.length} รายการใช่หรือไม่?`)) { return; }
          const codesToCancel = Array.from(selectedCheckboxes).map(cb => cb.dataset.code);
          try {
              const result = await callApi('cancelCodes', { codes: codesToCancel });
              alert(result.message);
              loadCodesForManagement();
              initializeAppData();
          } catch (error) { console.error("Failed to cancel codes:", error); }
      }
      
      function openEditModal(codeObject) {
          document.getElementById('edit-code-id').value = codeObject.id;
          const cleanVal = String(codeObject.code).replace(/['"‘’“”]/g, '').replace(/&#39;/g, '');
          document.getElementById('edit-code-value').value = cleanVal;
          document.getElementById('edit-code-type').value = codeObject.code_type || '';
          document.getElementById('edit-expiry-date').value = codeObject.expiry_date.slice(0, 10);
          $('#editCodeModal').modal('show');
      }

      async function handleUpdateCode() {
          const payload = { id: document.getElementById('edit-code-id').value, code_type: document.getElementById('edit-code-type').value, expiry_date: document.getElementById('edit-expiry-date').value };
          if (!payload.code_type || !payload.expiry_date) { return alert('กรุณากรอกข้อมูลให้ครบถ้วน'); }
          try {
              const result = await callApi('updateCodeDetails', payload);
              alert(result.message);
              $('#editCodeModal').modal('hide');
              loadCodesForManagement();
              initializeAppData();
          } catch (error) { console.error("Update failed:", error); }
      }
      
      async function loadDashboardData() {
        const dashboardContainer = document.getElementById('dashboard-container');
        dashboardContainer.innerHTML = '<p class="text-center">กำลังโหลดข้อมูล Dashboard...</p>';
        try {
            let data = await callApi('getAllDataForReport');
            const isServiceUser = currentUser && currentUser.email === 'toacream1@gmail.com';

            if (isServiceUser) {
                data = data.filter(code => code.code_type === 'Service');
            }

            const today = new Date(); today.setHours(0, 0, 0, 0);
            const summary = data.reduce((acc, code) => {
                const type = code.code_type || 'ไม่ระบุประเภท';
                if (!acc[type]) { acc[type] = { total: 0, used: 0, expired: 0 }; }
                acc[type].total++;
                if (code.status === 'ใช้แล้ว') { acc[type].used++; } 
                else if (code.status === 'ยังไม่ใช้' && new Date(code.expiry_date) < today) { acc[type].expired++; }
                return acc;
            }, {});

            dashboardSummaryData = {};
            Object.keys(summary).forEach(type => {
                const counts = summary[type];
                const remaining = counts.total - counts.used - counts.expired;
                dashboardSummaryData[type] = { ...counts, remaining };
            });

            dashboardContainer.innerHTML = '';
            if (Object.keys(dashboardSummaryData).length === 0) {
                dashboardContainer.innerHTML = '<p class="text-center text-secondary">ไม่พบข้อมูลโค้ดในระบบ</p>';
                return;
            }
            
            for (const [type, counts] of Object.entries(dashboardSummaryData)) {
                const groupHtml = `<div class="dashboard-group mb-4"><h5>ประเภท: ${type}</h5><div class="row"><div class="col-6 col-sm-3"><div class="dashboard-card-small card-total"><div class="icon"><i class="fas fa-ticket-alt"></i></div><h4>${counts.total}</h4><p>ทั้งหมด</p></div></div><div class="col-6 col-sm-3"><div class="dashboard-card-small card-used"><div class="icon"><i class="fas fa-check-circle"></i></div><h4>${counts.used}</h4><p>ใช้ไปแล้ว</p></div></div><div class="col-6 col-sm-3"><div class="dashboard-card-small card-expired"><div class="icon"><i class="fas fa-calendar-times"></i></div><h4>${counts.expired}</h4><p>หมดอายุ</p></div></div><div class="col-6 col-sm-3"><div class="dashboard-card-small card-remaining"><div class="icon"><i class="fas fa-hourglass-half"></i></div><h4>${counts.remaining}</h4><p>คงเหลือ</p></div></div></div></div>`;
                dashboardContainer.innerHTML += groupHtml;
            }
        } catch (error) {
            console.error("Failed to load dashboard data:", error);
            dashboardContainer.innerHTML = '<p class="text-center text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
        }
      }

      async function loadUsageReport() {
          const year = document.getElementById('reportYear').value;
          const tableBody = document.getElementById('usageReportTableBody');
          const colspan = 14;
          tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">กำลังโหลดข้อมูล...</td></tr>`;
          
          try {
              let allData = await callApi('getAllDataForReport');
              const isServiceUser = currentUser && currentUser.email === 'toacream1@gmail.com';

              if (isServiceUser) {
                  allData = allData.filter(code => code.code_type === 'Service');
              }
              
              const usageData = allData.filter(c => c.status === 'ใช้แล้ว' && new Date(c.used_at).getFullYear() == year);
              
              if(usageData.length === 0) {
                  tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">ไม่พบข้อมูลการใช้งานในปี ${year}</td></tr>`;
                  detailedUsageReportData = {};
                  return;
              }

              const groupedData = {};

              usageData.forEach(item => {
                  const type = item.code_type || 'ไม่ระบุประเภท';
                  const branch = item.branch_id || 'ไม่ระบุสาขา';
                  const month = new Date(item.used_at).getMonth() + 1;

                  if (!groupedData[type]) {
                      groupedData[type] = { 
                          total_months: { 1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0, total:0 },
                          branches: {} 
                      };
                  }
                  
                  groupedData[type].total_months[month]++;
                  groupedData[type].total_months.total++;

                  if (!groupedData[type].branches[branch]) {
                      groupedData[type].branches[branch] = { 1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0, total:0 };
                  }
                  groupedData[type].branches[branch][month]++;
                  groupedData[type].branches[branch].total++;
              });

              detailedUsageReportData = groupedData;
              tableBody.innerHTML = '';
              let typeIndex = 0;

              for (const [type, data] of Object.entries(groupedData)) {
                  typeIndex++;
                  const summary = data.total_months;
                  
                  let mainRowHtml = `
                    <tr class="clickable-row" data-toggle="collapse" data-target=".detail-${typeIndex}" aria-expanded="false">
                        <td class="font-weight-bold"><i class="fas fa-chevron-down mr-2" style="font-size: 0.8rem;"></i>${type}</td>
                        <td>${summary[1]}</td><td>${summary[2]}</td><td>${summary[3]}</td><td>${summary[4]}</td>
                        <td>${summary[5]}</td><td>${summary[6]}</td><td>${summary[7]}</td><td>${summary[8]}</td>
                        <td>${summary[9]}</td><td>${summary[10]}</td><td>${summary[11]}</td><td>${summary[12]}</td>
                        <td class="font-weight-bold bg-light">${summary.total}</td>
                    </tr>
                  `;
                  tableBody.innerHTML += mainRowHtml;

                  const sortedBranches = Object.keys(data.branches).sort();
                  
                  sortedBranches.forEach(branch => {
                      const bData = data.branches[branch];
                      let detailRowHtml = `
                        <tr class="collapse detail-row detail-${typeIndex}">
                            <td class="branch-name"><i class="fas fa-store-alt mr-1"></i> สาขา: ${branch}</td>
                            <td>${bData[1] || 0}</td><td>${bData[2] || 0}</td><td>${bData[3] || 0}</td><td>${bData[4] || 0}</td>
                            <td>${bData[5] || 0}</td><td>${bData[6] || 0}</td><td>${bData[7] || 0}</td><td>${bData[8] || 0}</td>
                            <td>${bData[9] || 0}</td><td>${bData[10] || 0}</td><td>${bData[11] || 0}</td><td>${bData[12] || 0}</td>
                            <td class="font-weight-bold">${bData.total}</td>
                        </tr>
                      `;
                      tableBody.innerHTML += detailRowHtml;
                  });
              }

              $('.clickable-row').click(function(){
                  $(this).attr('aria-expanded', $(this).attr('aria-expanded') === 'true' ? 'false' : 'true');
              });

          } catch(error) {
              console.error("Failed to load usage report:", error);
              tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
          }
      }

      function handleSmartExport() {
          const selectedCheckboxes = document.querySelectorAll('.code-checkbox:checked');
          let dataToExport = [];
          let fileNamePrefix = "";

          if (selectedCheckboxes.length > 0) {
              const selectedCodes = Array.from(selectedCheckboxes).map(cb => cb.dataset.code);
              dataToExport = currentDisplayedCodes.filter(item => {
                  const cleanItemCode = String(item.code).replace(/['"‘’“”]/g, '').replace(/&#39;/g, '');
                  return selectedCodes.includes(cleanItemCode);
              });
              fileNamePrefix = "Selected_Items";
          } else {
              dataToExport = currentDisplayedCodes;
              const filterDate = document.getElementById('manageFilterDate').value;
              const filterStatus = document.getElementById('manageFilterStatus').value;
              const filterSearch = document.getElementById('manageFilterSearch').value;
              const isFiltered = (filterDate !== "" || filterStatus !== "" || filterSearch.trim() !== "");
              fileNamePrefix = isFiltered ? "Filtered_Data" : "All_Data";
          }

          if (dataToExport.length === 0) return alert('ไม่มีข้อมูลสำหรับ Export');
          if (!confirm(`ยืนยันการ Export? จำนวน: ${dataToExport.length} รายการ`)) return;

          try {
              const today = new Date(); today.setHours(0, 0, 0, 0);
              const processedData = dataToExport.map(row => {
                  let computedStatus = row.status;
                  if (row.status === 'ยังไม่ใช้' && new Date(row.expiry_date) < today) {
                      computedStatus = 'หมดอายุ';
                  }
                  const cleanCode = String(row.code).replace(/['"‘’“”]/g, '').replace(/&#39;/g, '');
                  
                  return {
                      'Code': cleanCode,
                      'Type': row.code_type,
                      'Status': computedStatus,
                      'Branch': row.branch_id || '-', 
                      'Used Date': row.used_at ? new Date(row.used_at).toLocaleDateString('th-TH') : '-', 
                      'Created Date': new Date(row.created_at).toLocaleDateString('th-TH'),
                      'Expiry Date': new Date(row.expiry_date).toLocaleDateString('th-TH'),
                      'Notes': row.notes || '-'
                  };
              });

              const worksheet = XLSX.utils.json_to_sheet(processedData);
              const workbook = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(workbook, worksheet, "Codes");
              const todayStr = new Date().toISOString().slice(0, 10);
              XLSX.writeFile(workbook, `${fileNamePrefix}_${todayStr}.xlsx`);
              
          } catch (error) { 
              console.error("Export failed:", error); 
              alert("Export ไม่สำเร็จ: " + error.message);
          }
      }

      async function handleExport(type) {
        try {
            let dataToExport = [];
            let fileName;
            const today = new Date().toISOString().slice(0, 10);

            if(type === 'dashboard') {
                if (Object.keys(dashboardSummaryData).length === 0) { return alert('ไม่มีข้อมูล Dashboard สำหรับ Export'); }
                for (const [codeType, counts] of Object.entries(dashboardSummaryData)) {
                    dataToExport.push({ 'ประเภทโค้ด': codeType, 'ทั้งหมด': counts.total, 'ใช้ไปแล้ว': counts.used, 'หมดอายุ': counts.expired, 'คงเหลือ': counts.remaining });
                }
                fileName = `DashboardReport_${today}.xlsx`;
            
            } else if (type === 'usage_report') {
                if (Object.keys(detailedUsageReportData).length === 0) { return alert('ไม่มีข้อมูลในตารางให้ Export'); }
                
                const monthHeaders = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                
                for (const [codeType, typeData] of Object.entries(detailedUsageReportData)) {
                    const sortedBranches = Object.keys(typeData.branches).sort();
                    
                    sortedBranches.forEach(branch => {
                        const counts = typeData.branches[branch];
                        const rowData = { 
                            'ประเภทโค้ด': codeType,
                            'สาขา': branch
                        };
                        for (let i = 0; i < 12; i++) { rowData[monthHeaders[i]] = counts[i + 1]; }
                        rowData['รวม'] = counts.total;
                        dataToExport.push(rowData);
                    });
                }
                
                const year = document.getElementById('reportYear').value;
                fileName = `UsageReport_Detail_${year}_${today}.xlsx`;
            
            } else { return; }

            if (dataToExport.length === 0) { return alert('ไม่มีข้อมูลสำหรับ Export'); }

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Report");
            XLSX.writeFile(workbook, fileName);
        } catch (error) {
            console.error("Export failed:", error);
            alert("Export ไม่สำเร็จ: " + error.message);
        }
      }
    </script>
</body>
</html>
